name: Deploy GitHub Pages with EmailJS

on:
  push:
    branches: [ main ]
  # Remove pull_request trigger - secrets not available in PR context
  
# Allow manual trigger
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Inject EmailJS Configuration
        run: |
          # Ensure the directory exists
          mkdir -p assets/js
          
          # Create emailjs-env.js with environment variables - use printf for better control
          printf '%s\n' \
            '// EmailJS Environment Configuration - Auto-generated from GitHub Secrets' \
            "window.EMAILJS_PUBLIC_KEY = '${{ secrets.EMAILJS_PUBLIC_KEY }}';" \
            "window.EMAILJS_SERVICE_ID = '${{ secrets.EMAILJS_SERVICE_ID }}';" \
            "window.EMAILJS_TEMPLATE_ID = '${{ secrets.EMAILJS_TEMPLATE_ID }}';" \
            "window.EMAILJS_AUTOREPLY_TEMPLATE_ID = '${{ secrets.EMAILJS_AUTOREPLY_TEMPLATE_ID }}';" \
            '' \
            '// Debug information for deployment' \
            "console.log('üìß EmailJS Configuration loaded from GitHub Secrets (Production)');" \
            "console.log('üîë Public Key:', window.EMAILJS_PUBLIC_KEY ? 'Set ‚úÖ' : 'Missing ‚ùå');" \
            "console.log('üì¨ Service ID:', window.EMAILJS_SERVICE_ID ? 'Set ‚úÖ' : 'Missing ‚ùå');" \
            "console.log('üìù Template ID:', window.EMAILJS_TEMPLATE_ID ? 'Set ‚úÖ' : 'Missing ‚ùå');" \
            "console.log('üîÑ Auto-Reply Template ID:', window.EMAILJS_AUTOREPLY_TEMPLATE_ID ? 'Set ‚úÖ' : 'Missing ‚ùå');" \
            '' \
            '// Production deployment marker' \
            "window.EMAILJS_DEPLOYMENT = 'production';" \
            "window.EMAILJS_BUILD_TIME = '${{ github.run_number }}';" \
            "window.EMAILJS_BUILD_SHA = '${{ github.sha }}';" \
            '' \
            '// Fallback configuration check' \
            'if (!window.EMAILJS_PUBLIC_KEY || !window.EMAILJS_SERVICE_ID || !window.EMAILJS_TEMPLATE_ID) {' \
            "  console.warn('‚ö†Ô∏è EmailJS configuration incomplete - check GitHub Secrets');" \
            "  console.log('Required Secrets: EMAILJS_PUBLIC_KEY, EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, EMAILJS_AUTOREPLY_TEMPLATE_ID');" \
            '} else {' \
            "  console.log('‚úÖ EmailJS configuration complete');" \
            '}' \
            > assets/js/emailjs-env.js
          
          # Also inject EmailJS config directly into kontakt.html
          echo "=== Injecting EmailJS config into kontakt.html ==="
          
          # Replace placeholders in kontakt.html with actual values (using @ as delimiter and proper escaping)
          sed -i 's@${EMAILJS_PUBLIC_KEY}@${{ secrets.EMAILJS_PUBLIC_KEY }}@g' kontakt.html
          sed -i 's@${EMAILJS_SERVICE_ID}@${{ secrets.EMAILJS_SERVICE_ID }}@g' kontakt.html  
          sed -i 's@${EMAILJS_TEMPLATE_ID}@${{ secrets.EMAILJS_TEMPLATE_ID }}@g' kontakt.html
          sed -i 's@${EMAILJS_AUTOREPLY_TEMPLATE_ID}@${{ secrets.EMAILJS_AUTOREPLY_TEMPLATE_ID }}@g' kontakt.html
          
          echo "kontakt.html updated with EmailJS configuration"
          
          # Debug: Show what we created
          echo "=== Generated emailjs-env.js ==="
          cat assets/js/emailjs-env.js
          echo "=== File size and permissions ==="
          ls -la assets/js/emailjs-env.js
          
          echo "=== EmailJS config in kontakt.html ==="
          grep -A 5 -B 5 "EMAILJS_PUBLIC_KEY" kontakt.html || echo "No EMAILJS_PUBLIC_KEY found in kontakt.html"
          
          # Verify secrets are available (without exposing full values)
          echo "=== Secret availability check ==="
          echo "EMAILJS_PUBLIC_KEY exists: ${{ secrets.EMAILJS_PUBLIC_KEY != '' }}"
          echo "EMAILJS_SERVICE_ID exists: ${{ secrets.EMAILJS_SERVICE_ID != '' }}"
          echo "EMAILJS_TEMPLATE_ID exists: ${{ secrets.EMAILJS_TEMPLATE_ID != '' }}"
          echo "EMAILJS_AUTOREPLY_TEMPLATE_ID exists: ${{ secrets.EMAILJS_AUTOREPLY_TEMPLATE_ID != '' }}"
          
          # Show first/last few characters for verification (safe debugging)
          PUBLIC_KEY="${{ secrets.EMAILJS_PUBLIC_KEY }}"
          SERVICE_ID="${{ secrets.EMAILJS_SERVICE_ID }}"
          TEMPLATE_ID="${{ secrets.EMAILJS_TEMPLATE_ID }}"
          AUTOREPLY_ID="${{ secrets.EMAILJS_AUTOREPLY_TEMPLATE_ID }}"
          
          if [ -n "$PUBLIC_KEY" ]; then
            echo "PUBLIC_KEY format: ${PUBLIC_KEY:0:3}...${PUBLIC_KEY: -3}"
          else
            echo "‚ùå PUBLIC_KEY is empty!"
          fi
          
          if [ -n "$SERVICE_ID" ]; then
            echo "SERVICE_ID format: ${SERVICE_ID:0:8}...${SERVICE_ID: -3}"
          else
            echo "‚ùå SERVICE_ID is empty!"
          fi

      - name: Verify Build Structure
        run: |
          echo "=== Final build verification ==="
          echo "EmailJS file exists:"
          ls -la assets/js/emailjs-env.js || echo "‚ùå emailjs-env.js NOT found"
          
          echo "=== EmailJS file content verification ==="
          if [ -f "assets/js/emailjs-env.js" ]; then
            echo "File size: $(wc -c < assets/js/emailjs-env.js) bytes"
            echo "Content preview:"
            head -10 assets/js/emailjs-env.js
            
            # Check if variables are actually set (not empty)
            if grep -q "window.EMAILJS_PUBLIC_KEY = '';" assets/js/emailjs-env.js; then
              echo "‚ùå WARNING: PUBLIC_KEY is empty in generated file!"
            fi
            if grep -q "window.EMAILJS_SERVICE_ID = '';" assets/js/emailjs-env.js; then
              echo "‚ùå WARNING: SERVICE_ID is empty in generated file!"  
            fi
          else
            echo "‚ùå emailjs-env.js was not created!"
          fi
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4